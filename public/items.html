<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Items and their Quizzes</title>
    <style>
      body {
        font-family: Segoe UI, Arial;
        max-width: 900px;
        margin: 24px;
      }
      input,
      button,
      select {
        margin: 4px;
      }
      .item {
        border: 1px solid #ddd;
        padding: 8px;
        margin: 8px 0;
      }
      .quizzes {
        margin-left: 16px;
        color: #333;
      }
      .quiz {
        background: #f9f9f9;
        padding: 6px;
        margin: 4px 0;
      }
    </style>
  </head>
  <body>
    <h1>Items</h1>

    <form id="createForm">
      <label>Name: <input id="name" required /></label>
      <label>Description: <input id="desc" /></label>
      <button type="submit">Create Item</button>
    </form>

    <button id="refresh">Refresh</button>
    <div id="status"></div>
    <div id="items"></div>

    <script>
      const itemsEl = document.getElementById("items");
      const status = document.getElementById("status");

      async function loadData() {
        // fetch items and quizzes then group
        const [itemsRes, quizzesRes] = await Promise.all([
          fetch("/api/items"),
          fetch("/api/quizzes"),
        ]);
        const items = await itemsRes.json();
        const quizzes = await quizzesRes.json();

        // group quizzes by itemId
        const byItem = {};
        quizzes.forEach((q) => {
          const key = q.itemId == null ? "null" : String(q.itemId);
          (byItem[key] = byItem[key] || []).push(q);
        });

        itemsEl.innerHTML = "";
        items.forEach((it) => {
          const div = document.createElement("div");
          div.className = "item";
          div.dataset.id = it.id;
          const header = document.createElement("div");
          header.innerHTML = `<strong>#${it.id} ${it.name}</strong> - ${
            it.description || ""
          } <button data-id="${
            it.id
          }" class="del">Delete</button> <button data-id="${
            it.id
          }" class="edit">Edit</button>`;
          div.appendChild(header);

          const qlist = document.createElement("div");
          qlist.className = "quizzes";
          const qs = byItem[String(it.id)] || [];
          if (qs.length === 0) {
            qlist.textContent = "(no quizzes for this item)";
          } else {
            qs.forEach((q) => {
              const qdiv = document.createElement("div");
              qdiv.className = "quiz";
              qdiv.innerHTML = `#${q.id} <strong>${q.name}</strong> (solved:${q.solved} score:${q.score} answer:${q.answer}) <button data-qid="${q.id}" class="qview">View</button>`;
              qlist.appendChild(qdiv);
            });
          }
          div.appendChild(qlist);
          itemsEl.appendChild(div);
        });
      }

      document.getElementById("refresh").addEventListener("click", loadData);

      document
        .getElementById("createForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = document.getElementById("name").value;
          const description = document.getElementById("desc").value;
          const res = await fetch("/api/items", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, description }),
          });
          const j = await res.json();
          status.textContent = `Created item id=${j.id}`;
          loadData();
        });

      itemsEl.addEventListener("click", async (e) => {
        if (e.target.classList.contains("del")) {
          const id = e.target.dataset.id;
          await fetch(`/api/items/${id}`, { method: "DELETE" });
          loadData();
        }
        if (e.target.classList.contains("edit")) {
          const id = e.target.dataset.id;
          const name = prompt("New name?");
          const desc = prompt("New description?");
          if (name !== null) {
            const res = await fetch(`/api/items/${id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, description: desc }),
            });
            const j = await res.json();
            status.textContent = `Updated item id=${j.id}`;
            loadData();
          }
        }
        if (e.target.classList.contains("qview")) {
          const qid = e.target.dataset.qid;
          // open quiz detail page if desired
          window.location.href = `/quizzes.html#${qid}`;
        }
      });

      // initial
      loadData();
    </script>
  </body>
</html>
